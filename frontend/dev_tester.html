<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AI Anchor - Dev Tester</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      textarea { width: 100%; height: 160px; }
      select, button { margin: 8px 0; }
      pre { background: #f6f8fa; padding: 12px; border-radius: 6px; white-space: pre-wrap; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
      iframe { width: 100%; height: 360px; border: 1px solid #ddd; border-radius: 6px; background: #fff; }
    </style>
  </head>
  <body>
    <h2>AI Anchor - Dev Tester (no extension)</h2>
    <label>Action:
      <select id="action">
        <option value="summarize">summarize</option>
        <option value="explain_layman">explain_layman</option>
        <option value="explain_detailed">explain_detailed</option>
        <option value="sentiment">sentiment</option>
        <option value="find_sources">find_sources</option>
      </select>
    </label>
    <br />
    <textarea id="text" placeholder="Paste text here..."></textarea>
    <br />
    <button id="run">Run</button>
    <div class="row">
      <div>
        <h3>Raw result</h3>
        <pre id="out">(nothing yet)</pre>
      </div>
      <div>
        <h3>Rendered preview (matches extension)</h3>
        <iframe id="preview" sandbox="allow-same-origin"></iframe>
        <button id="open">Open result in new tab</button>
      </div>
    </div>

    <script>
      const BACKEND_URL = 'http://localhost:8000/api/analyze';
      const out = document.getElementById('out');
      const frame = document.getElementById('preview');
      const openBtn = document.getElementById('open');
      let lastHtml = '';

      function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function buildResultHtml(action, result) {
        const safeAction = escapeHtml(action);
        const formatted = renderResultContent(result);
        return `<!doctype html><html><head><meta charset="utf-8">
<title>AI Anchor result</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;padding:16px;line-height:1.5;color:#1f1f1f}
  h2{margin-top:0;font-size:20px}
  .result-text{white-space:pre-wrap;word-break:break-word;background:#f6f8fa;padding:12px;border-radius:6px;font-size:15px}
  .result-text a{color:#0b57d0;text-decoration:underline;word-break:break-word}
  .result-text strong{font-weight:600}
  .result-text em{font-style:italic}
</style></head>
<body><h2>${safeAction}</h2><div class="result-text">${formatted}</div></body></html>`;
      }

      function renderResultContent(text) {
        const escaped = escapeHtml(text || "");
        const withMarkdownLinks = escaped.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (match, label, url) => {
          return `<a href="${url}" target="_blank" rel="noopener noreferrer">${label}</a>`;
        });
        const withBareLinks = withMarkdownLinks.replace(/(^|[\s>])(https?:\/\/[^\s<]+)(?=$|[\s<])/gi, (match, prefix, url) => {
          const trimmed = url.replace(/[),.;!?]+$/, "");
          const trailing = url.slice(trimmed.length);
          return `${prefix}<a href="${trimmed}" target="_blank" rel="noopener noreferrer">${trimmed}</a>${trailing}`;
        });
        const withBold = withBareLinks.replace(/\*\*([^\*\n]+?)\*\*/g, "<strong>$1</strong>");
        const withItalics = withBold.replace(/(^|[\s(>_])\*([^\s*][^*]*?)\*/g, (match, prefix, value) => `${prefix}<em>${value}</em>`);
        return withItalics;
      }

      document.getElementById('run').addEventListener('click', async () => {
        const text = document.getElementById('text').value;
        const action = document.getElementById('action').value;
        out.textContent = 'Loading...';
        frame.srcdoc = '<!doctype html><html><body style="font-family:Arial;padding:16px">Loading...</body></html>';
        lastHtml = '';
        try {
          const controller = new AbortController();
          const timer = setTimeout(() => controller.abort(), 45000);
          const resp = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text, action }),
            signal: controller.signal,
          });
          clearTimeout(timer);

          const contentType = resp.headers.get('content-type') || '';
          const body = contentType.includes('application/json') ? (await resp.json()) : { raw: await resp.text() };
          if (!resp.ok) {
            const msg = `HTTP ${resp.status}: ${body.detail || body.raw || JSON.stringify(body)}`;
            out.textContent = msg;
            frame.srcdoc = `<!doctype html><html><body style="font-family:Arial;padding:16px;color:#b00020">${escapeHtml(msg)}</body></html>`;
            return;
          }

          const result = body.result || body.raw || JSON.stringify(body);
          out.textContent = result;

          // Build identical HTML to frontend/background.js
          lastHtml = buildResultHtml(action, result);
          frame.srcdoc = lastHtml;
        } catch (e) {
          const msg = 'Request failed: ' + (e?.message || e);
          out.textContent = msg;
          frame.srcdoc = `<!doctype html><html><body style="font-family:Arial;padding:16px;color:#b00020">${escapeHtml(msg)}</body></html>`;
        }
      });

      openBtn.addEventListener('click', () => {
        if (!lastHtml) return;
        const blob = new Blob([lastHtml], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        // Optionally revoke later
        setTimeout(() => URL.revokeObjectURL(url), 30000);
      });
    </script>
  </body>
  </html>
